map     $ssl_preread_server_name    $ssl_upstream_<%- port %> {
        default                     "<%- default || "" %>";
<% for ( const [name, socket] of Object.entrues( serverName ) ) { -%>
        "<%- name %>"               "<%- socket %>";
<% } -%>
}

server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen              *:<%- port %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen              [::]:<%- port %>;
<% } -%>

    proxy_pass          $ssl_upstream_<%- port %>;

    proxy_protocol      on;
    ssl_preread         on;
}
