map $ssl_preread_protocol $router_server_nme_<%- port %> {
        default
        $ssl_preread_server_name;

        ""
        "_";
}

map $router_server_nme_<%- port %> $router_socket_<%- port %> {
    hostnames;

    default
    "<%- defaultSslSocket ? `unix:${defaultSslSocket}` : `` %>";

    "_"
    "<%- defaultSocket ? `unix:${defaultSocket}` : `` %>";
<% for ( const [name, socket] of Object.entries( serverName ) ) { -%>

    "<%- name %>"
    "unix:<%- socket %>";
<% } -%>
}

server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen              *:<%- port %><%- proxyProtocol ? " proxy_protocol" : "" %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen              [::]:<%- port %><%- proxyProtocol ? " proxy_protocol" : "" %>;
<% } -%>

    proxy_pass          $router_upstream_<%- port %>;

    proxy_protocol      on;
    ssl_preread         on;
}
