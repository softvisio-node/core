daemon                       off;
worker_processes             auto;
pcre_jit                     on;
pid                          "<%- baseDir %>/nginx.pid";

events {
    worker_connections       8192;
}

http {
    server_tokens            off;

    default_type             "application/octet-stream";

    log_format               default "$time_local\t$remote_addr\t$status\t$body_bytes_sent\t$request";
    error_log                stderr crit;
    log_not_found            off;
    access_log               off;

    sendfile                 on;
    # aio                      on;
    # directio                 512;
    output_buffers           1 128K;

<% if ( cacheEnabled ) { -%>
    proxy_cache_path         "<%- cacheDir %>"
                             levels=1:2
                             keys_zone=default:10M
<% if ( cacheMaxSize ) { -%>
                             <%- "max_size=" + cacheMaxSize %>
<% } -%>
<% if ( cacheMinFree ) { -%>
                             <%- "min_free=" + cacheMinFree %>
<% } -%>
                             inactive=<%- cacheInactive %>
                             use_temp_path=off;
<% } -%>

    map     $http_connection $proxy_connection {
            default          "";
            "upgrade"        "upgrade";
    }

    # proxy
    proxy_http_version      1.1;
    proxy_set_header        Host              $host;
    proxy_set_header        X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header        Upgrade           $http_upgrade;
    proxy_set_header        Connection        $proxy_connection;
    proxy_hide_header       uwebsockets;
    proxy_cache_revalidate  on;
    proxy_cache_lock        on;

    # XXX ???
    # proxy_buffers           64 32K;
    # proxy_buffer_size       32K;

    # http servers
    include                  "<%- configsDir %>/*.http.nginx.conf";

    # default http server
    server {
        server_name "";

<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
        listen      *:80 default_server;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
        listen      [::]:80 default_server;
<% } -%>

        location / {
            return  444;
        }
<% if ( acmeChallengesProxy ) { -%>

        location /.well-known/acme-challenge/ {
            rewrite             /.well-known/acme-challenge/(.*)    <%- acmeChallengesLocation %>/$1   break;

            proxy_pass          <%- acmeChallengesProxy %>;
        }
<% } -%>
    }
}

stream {

    # stream servers
    include                  "<%- configsDir %>/*.stream.nginx.conf";
}
