daemon                       off;
worker_processes            auto;
pcre_jit                    on;
pid                         "<%- baseDir %>/nginx.pid";

events {
    worker_connections      8192;
}

http {
    server_tokens           off;

    default_type            "application/octet-stream";

    log_format              default "$time_local\t$remote_addr\t$status\t$body_bytes_sent\t$request";
    error_log               stderr crit;
    log_not_found           off;
    access_log              off;

    sendfile                on;
    # aio                      on;
    # directio                 512;
    output_buffers          1 128K;

    proxy_cache_path        "<%- cacheDir %>"
                            levels=1:2
                            keys_zone=main:10M
<% if ( cacheMaxSize ) { -%>
                            <%- "max_size=" + cacheMaxSize %>
<% } -%>
<% if ( cacheMinFree ) { -%>
                            <%- "min_free=" + cacheMinFree %>
<% } -%>
                            inactive=<%- cacheInactive %>
                            use_temp_path=off;

    proxy_cache             off;
    proxy_cache_bypass      <%- cacheBypass ? "$http_cache_control" : 0 %>;

    map     $http_connection            $proxy_connection {
            default                     "";
            "upgrade"                   "upgrade";
    }

    map     $proxy_protocol_addr        $forwarded_for_proxy_protocol {
            default                     "${proxy_protocol_addr}, ${remote_addr}";
            ""                          "${remote_addr}";
    }

    map     $http_x_forwarded_for       $proxy_protocol_add_x_forwarded_for {
            default                     "${http_x_forwarded_for}, ${forwarded_for_proxy_protocol}";
            ""                          $forwarded_for_proxy_protocol;
    }

    client_max_body_size    <%- maxBodySize %>;

    # proxy
    proxy_http_version      1.1;
    proxy_set_header        Host              $host;
    proxy_set_header        X-Forwarded-For   $proxy_protocol_add_x_forwarded_for;
    proxy_set_header        Upgrade           $http_upgrade;
    proxy_set_header        Connection        $proxy_connection;
    proxy_hide_header       uwebsockets;
    proxy_cache_revalidate  on;
    proxy_cache_lock        on;
    proxy_socket_keepalive  on;

    # XXX ???
    # proxy_buffers           64 32K;
    # proxy_buffer_size       32K;

    # unnamed http servers
    include                 "<%- configsDir %>/http-upstreams/*.nginx.conf";
    include                 "<%- configsDir %>/http-servers-default/*.nginx.conf";

    # default http server
    server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
        listen              *:80;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
        listen              [::]:80;
<% } -%>
        listen              "unix:<%- httpsSocketPath %>" ssl proxy_protocol;

        ssl_certificate     "<%- defaultCertificate %>";
        ssl_certificate_key "<%- defaultCertificateKey %>";

        location / {
            return          444;
        }
<% if ( privateHrrpServerUpstream && acmeChallengesUrl ) { -%>

        location /.well-known/acme-challenge/ {
            rewrite         /.well-known/acme-challenge/(.*)    <%- acmeChallengesUrl %>/$1   break;

            proxy_pass      "http://<%- privateHrrpServerUpstream %>";
        }
<% } -%>
    }

    # named http servers
    include                 "<%- configsDir %>/http-servers/*.nginx.conf";
}

stream {
    proxy_socket_keepalive  on;

    map     $ssl_preread_server_name    $ssl_443_upstream {
            default                     "unix:<%- httpsSocketPath %>";
            include                    "<%- configsDir %>/ssl-server-upstreams/*.443.nginx.conf";
    }

    server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
        listen              *:443;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
        listen              [::]:443;
<% } -%>

        proxy_pass          $ssl_443_upstream;

        proxy_protocol      on;
        ssl_preread         on;
    }

    # stream servers
    include                 "<%- configsDir %>/stram-upstreams/*.nginx.conf";
    include                 "<%- configsDir %>/stream-servers/*.nginx.conf";
}
