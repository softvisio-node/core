upstream <%- id %>-http {
    zone                     upstream-zone-<%- id %>-http 1m;
    least_conn;
    keepalive                512; # max. number of non-active upstream connections
    keepalive_timeout        180s;
    server                   0.0.0.0:1 down;
    # server                   <%- upstreamServer %>;
    # dns_update               30s;
    # dns_ipv6                 off;
}
<% if ( cacheEnabled ) { -%>

proxy_cache_path             <%- cacheDir %> levels=1:2:3 keys_zone=default:10M max_size=<%- cacheMaxSize %> max_free=<%- cacheMinFree %> inactive=<%- cacheInactive %> use_temp_path=off;
<% } -%>

server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen                   *:<%- port %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen                   [::]:<%- port %>;
<% } -%>
    server_name              <%- serverName %>;

    keepalive_timeout        180s;
    client_max_body_size     <%- clientMaxBodySize %>;

    location @backend {
        proxy_pass           http://<%- id %>-http;

        proxy_set_header     Host              $host;
        proxy_set_header     X-Real-IP         $remote_addr;
        proxy_set_header     X-Forwarded-For   $proxy_add_x_forwarded_for;
<% if ( cacheEnabled ) { -%>

        # cache
        proxy_cache          <%- id %>;
<% if ( httpProxyCacheBypass ) { -%>
        proxy_cache_bypass   $http_cache_control;
<% } -%>
<% if ( httpUpstreamCacheStatus ) { -%>
        add_header           X-Upstream-Cache-Status $upstream_cache_status;
<% } -%>
<% } -%>

        # websocket
        proxy_set_header     Upgrade    $http_upgrade;
        proxy_set_header     Connection $connection_upgrade;
    }

    location / {
        error_page           418 = @backend;
        return               418;
    }
}
