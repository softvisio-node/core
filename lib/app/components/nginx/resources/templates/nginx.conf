daemon                       off;
worker_processes             auto;
pcre_jit                     on;
pid                          <%- baseDir %>/nginx.pid;

events {
    worker_connections       8192;
}

http {
    default_type             application/octet-stream;

    log_format               default "$time_local\t$remote_addr\t$status\t$body_bytes_sent\t$request";
    error_log                stderr crit;
    log_not_found            off;
    access_log               off;

    sendfile                 on;
    # aio                      on;
    # directio                 512;
    output_buffers           1 128k;

    keepalive_timeout        180s;

    proxy_cache_revalidate   on;
    proxy_cache_lock         on;
    proxy_buffers            64 32k;
    proxy_buffer_size        32k;
    proxy_http_version       1.1;

    # resolver                 127.0.0.11 valid=30s;
    # resolver                 8.8.8.8 8.8.4.4 valid=30s;
    resolver_timeout         5s;

    server_tokens            off;

    # for websocket proxy connection
    map $http_connection     $connection_upgrade {
        ~*\bupgrade\b        "upgrade";
        default              "";
    }

    # default vhost
    server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
        listen               *:<%- port %> default_server;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
        listen               [::]:<%- port %> default_server;
<% } -%>
        server_name          "";

        location / {
            return           444;
        }

        location /check-health {
            return           200;
        }
    }

    # dynamic upstream
    server {
        listen               127.0.0.1:<%- port %>80;

        location / {
            return           444;
        }

        location /dynamic-upstream {
            dynamic_upstream;
        }
    }

    # vhosts
    include                  <%- vhostsDir %>/*.http.nginx.conf;
}

stream {

    # vhosts
    include                  <%- vhostsDir %>/*.stream.nginx.conf;
}
