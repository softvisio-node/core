upstream "<%- id %>" {
    zone                    "<%- id %>"
                            1M;
    least_conn;

<% for ( const upstream of upstreams ) { -%>
    server                  <%- upstream %>;
<% } -%>
}

server {
<% if ( port === 443 ) { -%>
    listen                  "unix:<%- unixSocketsPath %>/<%- id %>.443.socket" ssl proxy_protocol;
<% } else { -%>
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen                  *:<%- port %><%- sslEnabled ? " ssl" : "" %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen                  [::]:<%- port %><%- sslEnabled ? " ssl" : "" %>;
<% } -%>
<% } -%>
<% if ( sslCertificate ) { -%>

    ssl_certificate         "<%- sslCertificate %>";
    ssl_certificate_key     "<%- sslCertificateKey %>";
<% } -%>

    proxy_pass              "<%- id %>";

    proxy_protocol          <%- upstreamProxyProtocol ? "on" : "off" %>;


    # proxy_socket_keepalive   on;
    # proxy_connect_timeout    20s;
    # proxy_timeout            10M;
}
