<% for ( const streamPort of streamPorts ) { -%>
upstream <%- id %>-<%- streamPort %> {
    zone                    upstream-zone-<%- id %>-<%- streamPort %> 1m;
    least_conn;
    resolver_timeout        30s;

<% for ( const upstream of upstreams ) { -%>
    server                  upstream:<%- streamPort %> resolve;
<% } -%>
}

server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen                   *:<%- streamPort %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen                   [::]:<%- streamPort %>;
<% } -%>
    proxy_pass               <%- id %>-<%- streamPort %>;
    proxy_socket_keepalive   on;
    proxy_connect_timeout    20s;
    proxy_timeout            10m;
}

<% } -%>
