upstream <%- `${id}-${port}` %> {
    zone                    <%- `${id}-${port}` %>
                            1M;
    least_conn;
    keepalive               512; # max. number of non-active upstream connections
    keepalive_timeout       180s;

<% for ( const upstream of upstreams ) { -%>
    server                  <%- upstream %>;
<% } -%>
}

server {
<% if ( serverName ) { -%>
    server_name             <%- serverName %>;

<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen                  *:<%- port %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen                  [::]:<%- port %>;
<% } -%>
<% if ( sslCertificate ) { -%>
    listen                  "unix:<%- unixSocketsPath %>/http-443.socket" ssl proxy_protocol;

    ssl_certificate         "<%- sslCertificate %>";
    ssl_certificate_key     "<%- sslCertificateKey %>";
<% } -%>

    client_max_body_size    <%- maxBodySize %>;

    location @backend {
        proxy_pass          http://<%- `${id}-${port}` %>;

        proxy_cache         <%- cacheEnabled ? "main" : "off" %>;
        proxy_cache_bypass  <%- cacheBypass ? "$http_cache_control" : 0 %>;
    }

    location / {
<% if ( sslCertificate ) { -%>
        set                 $redirect_to_https 0;

        if ( $https != "on" ) {
            set             $redirect_to_https 1;
        }

        if ( $http_x_forwarded_proto = "https" ) {
            set             $redirect_to_https 0;
        }

        if ( $redirect_to_https ) {
            return          301 https://$host$request_uri;
        }

<% } -%>
        error_page          418 = @backend;
        return              418;
    }
<% if ( privateHrrpServerUpstream ) { -%>

    location /.well-known/acme-challenge/ {
        rewrite             /.well-known/acme-challenge/(.*)    <%- acmeChallengesUrl %>/$1   break;

        proxy_pass          http://<%- privateHrrpServerUpstream %>;
    }
<% } -%>
}
