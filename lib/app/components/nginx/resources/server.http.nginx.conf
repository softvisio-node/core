upstream <%- id %>-<%- httpPort %> {
    zone                upstream-zone-<%- id %>-<%- httpPort %>
                        1M;
    keepalive           512; # max. number of non-active upstream connections
    keepalive_timeout   180s;
    least_conn;

<% for ( const upstream of upstreams ) { -%>
    server  <%- upstream %>:<%- upstreamHttpPort %>;
<% } -%>
}

server {
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen      *:<%- httpPort %><%- defaultServer ? " default_server" : "" %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen      [::]:<%- httpPort %><%- defaultServer ? " default_server" : "" %>;
<% } -%>
    server_name <%- serverName %>;

    keepalive_timeout       180s;
    client_max_body_size    <%- maxBodySize %>;

    location @backend {
        proxy_pass          http://<%- id %>-<%- httpPort %>;

        proxy_http_version  1.1;

        proxy_set_header    Host              $host;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    Upgrade           $http_upgrade;
        proxy_set_header    Connection        $proxy_connection;

        proxy_hide_header   uwebsockets;
<% if ( cacheEnabled ) { -%>

        # cache
        proxy_cache             default;
        proxy_cache_revalidate  on;
        proxy_cache_lock        on;
<% if ( cacheBypass ) { -%>
        proxy_cache_bypass      $http_cache_control;
<% } -%>
<% if ( cacheStatus ) { -%>
        add_header              X-Upstream-Cache-Status $upstream_cache_status;
<% } -%>
<% } -%>
    }

    location / {
        error_page  418 = @backend;
        return      418;
    }
}
