server {
<% if ( !server.isDefaultServer ) { -%>
    server_name             <%- server.serverName.join( " " ) %>;

<% } -%>
<% if ( useRouter ) { -%>
    listen                  "unix:<%- server.socketPath %>"<%- server.isDefaultServer ? " default_server" : ""  ? " ssl" : "" %><%- server.ssl ? " ssl" : "" %> proxy_protocol;
<% } else { -%>
<% if ( nginx.listenIpV4 ) { -%>
    listen                  *:<%- server.port %><%- server.isDefaultServer ? " default_server" : ""  ? " ssl" : "" %><%- server.ssl ? " ssl" : "" %><%- server.proxyProtocol ? " proxy_protocol" : "" %>;
<% } -%>
<% if ( nginx.listenIpV6 ) { -%>
    listen                  [::]:<%- server.port %><%- server.isDefaultServer ? " default_server" : ""  ? " ssl" : "" %><%- server.ssl ? " ssl" : "" %><%- server.proxyProtocol ? " proxy_protocol" : "" %>;
<% } -%>
<% } -%>
<% if ( server.ssl ) { -%>

    ssl_certificate         "<%- server.ssl.certificate %>";
    ssl_certificate_key     "<%- server.ssl.certificateKey %>";
<% } -%>

    real_ip_header          <%- useRouter || server.proxyProtocol ? "proxy_protocol" : "X-Forwarded-For" %>; # X-Real-IP
    client_max_body_size    <%- server.maxBodySize %>;

    location @backend {
        proxy_pass          "http://<%- server.proxy.id %>";

        proxy_cache         <%- server.cacheEnabled ? `"main"` : "off" %>;
        proxy_cache_bypass  <%- server.cacheBypass ? "$http_cache_control" : 0 %>;
    }

    location / {
        error_page          418 = @backend;

        return              418;
    }
<% if ( server.port === 80 && !server.ssl && nginx.privateHrrpServerUpstream && nginx.acmeChallengesUrl && nginx.acme ) { -%>

    location /.well-known/acme-challenge/ {
        rewrite             /.well-known/acme-challenge/(.*)    <%- nginx.acmeChallengesUrl %>/$1   break;

        proxy_pass          "http://<%- nginx.privateHrrpServerUpstream %>";
    }

    location /.well-known/acme-challenge/test {
        add_header          X-ACME-Test     "<%- nginx.acme.acmeAccountKeyHash %>";

        return              200;
    }
<% } -%>
}
