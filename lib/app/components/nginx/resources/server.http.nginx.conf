server {
<% if ( server.serverName.length ) { -%>
    server_name             <%- server.serverName.join( " " ) %>;

<% } -%>
<% if ( server.port === 443 ) { -%>
    listen                  "unix:<%- unixSocketsPath %>/_http.443.socket" ssl proxy_protocol;
<% } else { -%>
<% if ( !listenIpFamily || listenIpFamily === 4 ) { -%>
    listen                  *:<%- server.port %><%- server.sslEnabled ? " ssl" : "" %><%- server.proxyProtocol ? " proxy_protocol" : "" %>;
<% } -%>
<% if ( !listenIpFamily || listenIpFamily === 6 ) { -%>
    listen                  [::]:<%- server.port %><%- server.sslEnabled ? " ssl" : "" %><%- server.proxyProtocol ? " proxy_protocol" : "" %>;
<% } -%>
<% } -%>
<% if ( server.sslEnabled ) { -%>

    ssl_certificate         "<%- server.ssl.certificate %>";
    ssl_certificate_key     "<%- server.ssl.certificateKey %>";
<% } -%>

    client_max_body_size    <%- server.maxBodySize %>;

    location @backend {
        proxy_pass          "http://<%- upstream.id %>";

        proxy_cache         <%- server.cacheEnabled ? "main" : "off" %>;
        proxy_cache_bypass  <%- server.cacheBypass ? "$http_cache_control" : 0 %>;
    }

    location / {
<% if ( sslCertificate ) { -%>
        set                 $redirect_to_https 0;

        if ( $https != "on" ) {
            set             $redirect_to_https 1;
        }

        if ( $http_x_forwarded_proto = "https" ) {
            set             $redirect_to_https 0;
        }

        if ( $redirect_to_https ) {
            return          301 https://$host$request_uri;
        }

<% } -%>
        error_page          418 = @backend;
        return              418;
    }
<% if ( privateHrrpServerUpstream && acmeChallengesUrl ) { -%>

    location /.well-known/acme-challenge/ {
        rewrite             /.well-known/acme-challenge/(.*)    <%- acmeChallengesUrl %>/$1   break;

        proxy_pass          "http://<%- privateHrrpServerUpstream %>";
    }
<% } -%>
}
